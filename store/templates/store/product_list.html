{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row">
        <!-- Filter Sidebar -->
        <aside class="lg:w-1/4 pr-8 mb-8 lg:mb-0">
            <div class="sticky top-24">
                <h2 class="text-2xl font-bold mb-4">Filters</h2>

                <!-- Category Filter -->
                <div class="mb-6">
                    <h3 class="font-semibold mb-2">Category</h3>
                    <div class="space-y-2">
                        <a href="{% url 'store:product_list' %}"
                           class="block w-full text-left hover:text-red-600 {% if not category %}font-bold text-red-600{% endif %}">
                            All
                        </a>
                        {% for cat in categories %}
                        <a href="{% url 'store:product_list_by_category' cat.slug %}"
                           class="block w-full text-left hover:text-red-600 {% if category and category.slug == cat.slug %}font-bold text-red-600{% endif %}">
                            {{ cat.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Gender Filter with HTMX -->
                <div class="mb-6">
                    <h3 class="font-semibold mb-2">Gender</h3>
                    <div class="space-y-2">
                        <button hx-get="{% url 'store:product_list' %}{% if category %}?category_slug={{ category.slug }}{% endif %}"
                                hx-target="#product-grid"
                                hx-push-url="true"
                                class="block w-full text-left hover:text-red-600 {% if not request.GET.gender or request.GET.gender == 'all' %}font-bold text-red-600{% endif %}">
                            All
                        </button>
                        <button hx-get="{% url 'store:product_list' %}?gender=Men{% if category %}&category_slug={{ category.slug }}{% endif %}"
                                hx-target="#product-grid"
                                hx-push-url="true"
                                class="block w-full text-left hover:text-red-600 {% if request.GET.gender == 'Men' %}font-bold text-red-600{% endif %}">
                            Men
                        </button>
                        <button hx-get="{% url 'store:product_list' %}?gender=Women{% if category %}&category_slug={{ category.slug }}{% endif %}"
                                hx-target="#product-grid"
                                hx-push-url="true"
                                class="block w-full text-left hover:text-red-600 {% if request.GET.gender == 'Women' %}font-bold text-red-600{% endif %}">
                            Women
                        </button>
                    </div>
                </div>

                <!-- Price Filter -->
                <div class="mb-6">
                    <h3 class="font-semibold mb-2">Price</h3>
                    <input type="range"
                           min="0"
                           max="500"
                           value="{{ request.GET.price_max|default:'500' }}"
                           oninput="document.getElementById('price-value').textContent = this.value"
                           onchange="applyPriceFilter(this.value)"
                           class="w-full">
                    <div class="text-sm text-gray-600 text-center mt-1">
                        Up to $<span id="price-value">{{ request.GET.price_max|default:'500' }}</span>
                    </div>
                </div>

                <button onclick="resetFilters()"
                        class="w-full bg-gray-700 text-white py-2 rounded-md hover:bg-gray-800 transition-colors">
                    Reset Filters
                </button>
            </div>
        </aside>

        <!-- Product Grid -->
        <main class="lg:w-3/4">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">
                    {% if category %}{{ category.name }}{% else %}All Products{% endif %}
                    {% if request.GET.gender and request.GET.gender != 'all' %}
                    - {{ request.GET.gender }}
                    {% endif %}
                </h1>
                <div class="flex items-center space-x-4">
                    <select onchange="applySort(this.value)"
                            class="border rounded-md px-4 py-2">
                        <option value="">Sort by</option>
                        <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>Name A-Z</option>
                        <option value="-name" {% if request.GET.sort == '-name' %}selected{% endif %}>Name Z-A</option>
                        <option value="price" {% if request.GET.sort == 'price' %}selected{% endif %}>Price: Low to High</option>
                        <option value="-price" {% if request.GET.sort == '-price' %}selected{% endif %}>Price: High to Low</option>
                        <option value="-created" {% if request.GET.sort == '-created' %}selected{% endif %}>Newest</option>
                    </select>
                </div>
            </div>

            <!-- Search Form -->
            <form method="GET" action="." class="mb-6">
                <div class="relative">
                    <input type="text"
                           name="q"
                           placeholder="Search products..."
                           value="{{ request.GET.q }}"
                           class="w-full border rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-red-300">
                    <button type="submit" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
            </form>

            <!-- Products Grid -->
            <div id="product-grid">
                {% if products %}
                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6">
                    {% for product in products %}
                    <div>
                        {% include 'components/_product_card.html' with product=product %}
                    </div>
                    {% endfor %}
                </div>

                {% if not products %}
                <div class="col-span-full text-center py-16">
                    <p class="text-xl text-gray-500">No products found.</p>
                    <a href="{% url 'store:product_list' %}"
                       class="mt-4 inline-block bg-red-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-red-700 transition-colors">
                        View All Products
                    </a>
                </div>
                {% endif %}

                {% else %}
                <div class="col-span-full text-center py-16">
                    <p class="text-xl text-gray-500">Loading products...</p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>
</div>

<script>
    // HTMX Filter Functions
    function applyGenderFilter(gender) {
        const baseUrl = "{% url 'store:product_list' %}";
        const category = "{% if category %}{{ category.slug }}{% endif %}";
        const params = new URLSearchParams();

        if (gender && gender !== 'all') params.append('gender', gender);
        if (category) params.append('category_slug', category);

        htmx.ajax('GET', `${baseUrl}?${params.toString()}`, {target: '#product-grid', swap: 'innerHTML'});
    }

    function applyPriceFilter(price) {
        const baseUrl = "{% url 'store:product_list' %}";
        const params = new URLSearchParams(window.location.search);
        params.set('price_max', price);

        htmx.ajax('GET', `${baseUrl}?${params.toString()}`, {target: '#product-grid', swap: 'innerHTML'});
    }

    function applySort(sortValue) {
        if (!sortValue) return;

        const baseUrl = "{% url 'store:product_list' %}";
        const params = new URLSearchParams(window.location.search);
        params.set('sort', sortValue);

        htmx.ajax('GET', `${baseUrl}?${params.toString()}`, {target: '#product-grid', swap: 'innerHTML'});
    }

    function resetFilters() {
        const baseUrl = "{% url 'store:product_list' %}";
        const category = "{% if category %}{{ category.slug }}{% endif %}";

        if (category) {
            htmx.ajax('GET', `${baseUrl}?category_slug=${category}`, {target: '#product-grid', swap: 'innerHTML'});
        } else {
            htmx.ajax('GET', baseUrl, {target: '#product-grid', swap: 'innerHTML'});
        }
    }

    // Initialize HTMX
    document.addEventListener('DOMContentLoaded', function() {
        // Update price display
        const priceSlider = document.querySelector('input[type="range"]');
        const priceValue = document.getElementById('price-value');

        if (priceSlider && priceValue) {
            priceSlider.addEventListener('input', function() {
                priceValue.textContent = this.value;
            });
        }
    });
</script>
{% endblock %}